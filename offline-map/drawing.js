import UTILITIES from"https://www.gteh.top/offline-map/utilities.js";import DOCUMENT from"https://www.gteh.top/offline-map/document.js";import SETTINGS from"./settings.js";import ACTIONS from"https://www.gteh.top/offline-map/actions.js";import DATA from"https://www.gteh.top/offline-map/data.js";const OBJECT_CACHE={},DRAWING={drawMap:(e,t,o)=>{for(const n in OBJECT_CACHE)n in e||n in t||n in o||(CANVAS.remove(OBJECT_CACHE[n]),delete OBJECT_CACHE[n]);const n=Object.values(OBJECT_CACHE);CANVAS.getObjects().forEach(e=>{n.includes(e)||CANVAS.remove(e)});const i=t=>{addLine(t,e[t]),delete e[t]},s=e=>{addStation(e,t[e]),delete t[e]},r=e=>{addConnection(e,o[e]),delete o[e]};setTimeout(()=>UTILITIES.runForTime(o,r,setTimeout(()=>UTILITIES.runForTime(t,s,setTimeout(()=>UTILITIES.runForTime(e,i,null)))))),document.getElementById("loading").style.display="none",CANVAS.backgroundColor=UTILITIES.convertColor(UTILITIES.getColorStyle("--backgroundColor"))},drawTest:(e,t,o)=>{CANVAS.clear(),addStation("Middle",{width:6*SETTINGS.size*(e+1),height:12*SETTINGS.size,left:0,top:0,angle:t,connections:[]});for(let n=0;n<8;n++){const i=400*Math.cos(2*Math.PI*(n+.5)/8),s=400*Math.sin(2*Math.PI*(n+.5)/8);addStation(`Outer ${n}`,{width:6*SETTINGS.size*(e+1),height:12*SETTINGS.size,left:i,top:s,angle:o,connections:[]});for(let r=0;r<e;r++)addLine(`test_line_${n}_${r}`,{color:Math.round(16777215*Math.random()),segments:[{x:0,y:0,direction:t,offsetIndex:r,routeCount:e},{x:i,y:s,direction:o,offsetIndex:r,routeCount:e}],selected:!0})}document.getElementById("loading").style.display="none"},zoomToPoint:(e,t)=>{targetX=e*zoom-window.innerWidth/2,targetY=t*zoom-window.innerHeight/2,startX=-getCanvasOffsetX(),startY=-getCanvasOffsetY()},zoom:(e,t,o)=>{const n=.999**e;zoom*=n,Object.values(OBJECT_CACHE).forEach(e=>{"updateShape"in e?e.updateShape():(e.left*=n,"topOffset"in e?e.top=(e.top-e.topOffset)*n+e.topOffset:e.top*=n)});const i=t-getCanvasOffsetX(),s=o-getCanvasOffsetY();CANVAS.relativePan(new fabric.Point(i-i*n,s-s*n))},getCenterLatLon:()=>[(getCanvasOffsetY()-window.innerHeight/2)/zoom,-(getCanvasOffsetX()-window.innerWidth/2)/zoom,window.innerHeight/zoom,window.innerWidth/zoom]};let mouseDown=0,shouldClearPanes=!1,touchX=0,touchY=0,fingerCount=0,twoFingerDistance=0,zoom=1,startX=0,startY=0,targetX=void 0,targetY=void 0,legendVisibleLines=[],previousLegendString="",hoveredLines=[];const CANVAS=new fabric.Canvas("canvas",{renderOnAddRemove:!1,selection:!1,backgroundColor:UTILITIES.convertColor(UTILITIES.getColorStyle("--backgroundColor"))});CANVAS.absolutePan(new fabric.Point(-window.innerWidth/2,-window.innerHeight/2));const getCanvasOffsetX=()=>CANVAS.viewportTransform[4],getCanvasOffsetY=()=>CANVAS.viewportTransform[5],resize=()=>{CANVAS.setWidth(window.innerWidth),CANVAS.setHeight(window.innerHeight),document.getElementById("search").style.maxWidth=window.innerWidth-32+"px",document.getElementById("station_info").style.maxHeight=window.innerHeight-80+"px";const e=document.getElementById("legend");e.style.maxWidth=window.innerWidth-432+"px",e.style.maxHeight=window.innerHeight-32+"px"};window.onresize=resize,resize(),CANVAS.on("mouse:down",e=>{mouseDown=Date.now(),shouldClearPanes=!0,twoFingerDistance=0;const t=e.e;if("touches"in t){const e=t.touches.length;let o=0,n=0;for(let i=0;i<e;i++)o+=t.touches[i].pageX,n+=t.touches[i].pageY;touchX=o/e,touchY=n/e}}),CANVAS.on("mouse:up",e=>{const t=e.e;"touches"in t&&0!==t.touches.length||(mouseDown=0),shouldClearPanes&&(DOCUMENT.clearPanes(!0),DATA.redraw())}),CANVAS.on("mouse:move",e=>{const t=e.e;if(mouseDown>0)if("movementX"in t&&"movementY"in t)CANVAS.relativePan(new fabric.Point(t.movementX,t.movementY)),shouldClearPanes=!1;else if("touches"in t){const e=t.touches.length;if(e>0){let o=0,n=0;for(let i=0;i<e;i++)o+=t.touches[i].pageX,n+=t.touches[i].pageY;o/=e,n/=e;const i=e>1?distanceSquared(t.touches[0].pageX,t.touches[0].pageY,t.touches[1].pageX,t.touches[1].pageY):0;e===fingerCount&&(twoFingerDistance>0&&DRAWING.zoom((twoFingerDistance-i)/50,o,n),CANVAS.relativePan(new fabric.Point(o-touchX,n-touchY))),touchX=o,touchY=n,twoFingerDistance=i}fingerCount=e,Date.now()-mouseDown>100&&(shouldClearPanes=!1)}t.stopPropagation()}),CANVAS.on("mouse:wheel",e=>{const t=e.e;DRAWING.zoom(t.deltaY,t.offsetX,t.offsetY),t.preventDefault(),t.stopPropagation()});const distanceSquared=(e,t,o,n)=>Math.abs(o-e)**2+Math.abs(n-t)**2,inBounds=(e,t)=>UTILITIES.isBetween(e,-getCanvasOffsetX(),window.innerWidth-getCanvasOffsetX())&&UTILITIES.isBetween(t,-getCanvasOffsetY(),window.innerHeight-getCanvasOffsetY()),inWindow=(e,t,o,n)=>{const i=Math.min(e,o),s=Math.min(t,n),r=Math.max(e,o),a=Math.max(t,n);return i<window.innerWidth-getCanvasOffsetX()&&r>-getCanvasOffsetX()&&s<window.innerHeight-getCanvasOffsetY()&&a>-getCanvasOffsetY()},addConnection=(e,t)=>{const{x1:o,y1:n,x2:i,y2:s,selected:r}=t,a=new fabric.Line([],{fill:null,stroke:UTILITIES.convertColor(UTILITIES.getColorStyle(r?"--textColor":"--textColorDisabled")),strokeWidth:4*SETTINGS.size,strokeDashArray:[8*SETTINGS.size,4*SETTINGS.size],objectCaching:!1,hoverCursor:"pointer",selectable:!1,updateShape:()=>{const e=o===i?n>s:o>i,t=(e?o:i)*zoom,r=(e?n:s)*zoom-2*SETTINGS.size,l=(e?i:o)*zoom,d=(e?s:n)*zoom-2*SETTINGS.size;return a.set({x1:t,y1:r,x2:l,y2:d}),inBounds(t,r)||inBounds(l,d)||inWindow(t,r,l,d)},checkVisibility:()=>{const e=a.updateShape();CANVAS.getObjects().includes(a)?e||CANVAS.remove(a):e&&CANVAS.sendToBack(a)},z:r?1:0});CANVAS.remove(OBJECT_CACHE[e]),OBJECT_CACHE[e]=a,a.checkVisibility()},addStation=(e,t)=>{const{id:o,name:n,width:i,height:s,left:r,top:a,angle:l,selected:d,types:c}=t,T=(0===l?s:(i+s-1)/Math.SQRT2)/2,S=[new fabric.Rect({originX:"center",originY:"center",width:i,height:s,rx:6*SETTINGS.size,ry:6*SETTINGS.size,angle:l,fill:UTILITIES.convertColor(UTILITIES.getColorStyle("--backgroundColor")),stroke:UTILITIES.convertColor(UTILITIES.getColorStyle(d?"--textColor":"--textColorDisabled")),strokeWidth:2*SETTINGS.size,hoverCursor:"pointer",selectable:!1})];if(d&&SETTINGS.showText){const e=n.split("|");let t=0;for(let o=0;o<e.length;o++){const n=e[o],i=SETTINGS.size*(UTILITIES.isCJK(n)?18:9);S.push(new fabric.Text(n,{top:T+2*SETTINGS.size+t,fontFamily:UTILITIES.fonts.join(","),fontSize:i,fill:UTILITIES.convertColor(UTILITIES.getColorStyle("--textColor")),stroke:UTILITIES.convertColor(UTILITIES.getColorStyle("--backgroundColor")),strokeWidth:4,paintFirst:"stroke",originX:"center",originY:"top",hoverCursor:"pointer",selectable:!1})),t+=i}let o="",i=0;if(Object.keys(UTILITIES.routeTypes).forEach(e=>{!SETTINGS.selectedRouteTypes.includes(e)&&c.includes(e)&&(o+=UTILITIES.routeTypes[e],i++)}),o){const e=new fabric.Text(o,{top:T+2*SETTINGS.size+t+4,fontFamily:"Material Icons",fontSize:18*SETTINGS.size,fill:UTILITIES.convertColor(UTILITIES.getColorStyle("--textColor")),stroke:UTILITIES.convertColor(UTILITIES.getColorStyle("--backgroundColor")),strokeWidth:4,paintFirst:"stroke",originX:"center",originY:"top",hoverCursor:"pointer",selectable:!1});S.push(e);const n=document.createElement("canvas").getContext("2d");n.font=`${18*SETTINGS.size}px Material Icons`,e.set({width:n.measureText(o).width})}}const h=new fabric.Group(S,{left:r*zoom,top:a*zoom-T-SETTINGS.size,topOffset:-T-SETTINGS.size,originX:"center",originY:"top",subTargetCheck:!0,hoverCursor:"default",selectable:!1,checkVisibility:()=>{const e=inBounds(r*zoom,a*zoom);CANVAS.getObjects().includes(h)?e||CANVAS.remove(h):e&&CANVAS.add(h)},z:d?8:4});S.forEach(e=>{e.on("mouseover",()=>h.set("shadow",`${UTILITIES.convertColor(UTILITIES.getColorStyle("--textColor"))} 0 0 8px`)),e.on("mouseout",()=>h.set("shadow","")),e.on("mouseup",()=>{!mouseDown&&shouldClearPanes&&(ACTIONS.onClickStation(o),shouldClearPanes=!1)})}),CANVAS.remove(OBJECT_CACHE[e]),OBJECT_CACHE[e]=h,h.checkVisibility()},addLine=(e,t)=>{const{color:o,segments:n,selected:i,density:s,id:r}=t,a=e.endsWith("_arrows1")||e.endsWith("_arrows2"),l=UTILITIES.getColorStyle("--textColorDisabled");let d;if(a)d=UTILITIES.getColorStyle("--backgroundColor");else if(1===SETTINGS.densityView){const e=(255&l)*(1-s);d=(Math.floor((o>>16&255)*s+e)<<16)+(Math.floor((o>>8&255)*s+e)<<8)+Math.floor((255&o)*s+e)}else d=2===SETTINGS.densityView?s>0?(Math.floor(102*(1-s))<<16)+(Math.floor(204*s)<<8)+13056:l:o;const c=new fabric.Polyline([],{fill:null,stroke:`${UTILITIES.convertColor(i||a?d:l)}${UTILITIES.testMode?"50":""}`,strokeWidth:SETTINGS.size*(a?2:6),strokeLineCap:"round",strokeLineJoin:"round",objectCaching:!1,hoverCursor:"pointer",selectable:!1,routeId:r,updateShape:()=>{const t=n[0],o=n[1],i=t.x*zoom,s=t.y*zoom,r=o.x*zoom,l=o.y*zoom,d=[],T=UTILITIES.connectLine(i,s,t.direction,t.offsetIndex,t.routeCount,r,l,o.direction,o.offsetIndex,o.routeCount,6*SETTINGS.size,d);if(a){let t=0,o=0,n=0,i=0;for(let e=0;e<d.length-1;e++){const s=d[e].x,r=d[e].y,a=d[e+1].x,l=d[e+1].y,c=(a-s)*(a-s)+(l-r)*(l-r);c>t?(o=t,t=c,i=n,n=e):c>o&&(o=c,i=e)}const s=e.endsWith("_arrows1")?n:i,r=d[s].x,a=d[s].y,l=d[s+1].x,S=d[s+1].y,h=Math.sign(l-r),I=Math.sign(S-a),C=(r+l)/2,g=(a+S)/2,u=2*SETTINGS.size,f=T?-1:1;c.points=[],0===Math.abs(l-r)?(c.points.push({x:C-u,y:g-I*u*f}),c.points.push({x:C,y:g}),c.points.push({x:C+u,y:g-I*u*f})):0===Math.abs(S-a)?(c.points.push({x:C-h*u*f,y:g-u}),c.points.push({x:C,y:g}),c.points.push({x:C-h*u*f,y:g+u})):(c.points.push({x:C-h*u*f*Math.SQRT2,y:g}),c.points.push({x:C,y:g}),c.points.push({x:C,y:g-I*u*f*Math.SQRT2}))}else c.points=d;return inBounds(i,s)||inBounds(r,l)||inWindow(i,s,r,l)},checkVisibility:()=>{const e=c.updateShape();CANVAS.getObjects().includes(c)?e||CANVAS.remove(c):e&&CANVAS.sendToBack(c),e&&!legendVisibleLines.includes(r)&&legendVisibleLines.push(r)},z:(i?6:2)+(a?1:0)});CANVAS.remove(OBJECT_CACHE[e]),OBJECT_CACHE[e]=c,c.checkVisibility()},getSegment=(e,t)=>{hoveredLines=[],CANVAS.getObjects().forEach(o=>{if("points"in o){const n=o.points;for(let i=1;i<n.length;i++){const s=n[i-1],r=n[i];let a=s.x+getCanvasOffsetX(),l=s.y+getCanvasOffsetY(),d=r.x+getCanvasOffsetX(),c=r.y+getCanvasOffsetY(),T=e,S=t,h=Math.min(a,d),I=Math.min(l,c),C=Math.max(a,d),g=Math.max(l,c);const u=()=>UTILITIES.isBetween(T,h-3*SETTINGS.size,C+3*SETTINGS.size)&&UTILITIES.isBetween(S,I-3*SETTINGS.size,g+3*SETTINGS.size);if(u())if(a!==d&&l!==c){const e=UTILITIES.rotatePoint(a,l,45);a=e.x,l=e.y;const t=UTILITIES.rotatePoint(d,c,45);d=t.x,c=t.y;const n=UTILITIES.rotatePoint(T,S,45);T=n.x,S=n.y,h=Math.min(a,d),I=Math.min(l,c),C=Math.max(a,d),g=Math.max(l,c),u()&&hoveredLines.push(o.routeId)}else hoveredLines.push(o.routeId)}}})},checkAllVisibility=()=>{const e={...OBJECT_CACHE};UTILITIES.runForTime(e,t=>{e[t]&&t in OBJECT_CACHE&&OBJECT_CACHE[t].checkVisibility(),e[t]=void 0},()=>setTimeout(checkAllVisibility)),legendVisibleLines.sort();const t=legendVisibleLines.join(",")+SETTINGS.selectedRoutes.join(",")+Object.keys(SETTINGS.selectedDirectionsSegments).join(","),o=document.getElementById("legend");t!==previousLegendString&&(o.innerText="",legendVisibleLines.forEach(e=>{const t=DATA.json[SETTINGS.dimension].routes.find(t=>t.id===e);t&&o.appendChild(ACTIONS.getRouteElement(e,t.color,t.name,t.number,t.type,!0,DATA.routeSelected(e),"",!1))})),previousLegendString=t,o.style.display=!SETTINGS.showLegend||0===legendVisibleLines.length||window.innerWidth<480?"none":"",legendVisibleLines=[]};checkAllVisibility();const STEPS=50,MIN_SPEED=1e-4,SPEED_MULTIPLIER=3,delta=1,update=()=>{if(requestAnimationFrame(update),void 0!==targetX&&void 0!==targetY){const e=(targetX-startX)**2+(targetY-startY)**2,t=0===e?1:Math.sqrt(((getCanvasOffsetX()+startX)**2+(getCanvasOffsetY()+startY)**2)/e),o=3*Math.sqrt(t<.5?Math.max(t,1e-4):1-t);CANVAS.relativePan(new fabric.Point(-o*(targetX-startX)/50,-o*(targetY-startY)/50)),(t>=1||(-getCanvasOffsetX()-startX)/(targetX-startX)>=1||(-getCanvasOffsetY()-startY)/(targetY-startY)>=1)&&(CANVAS.absolutePan(new fabric.Point(targetX,targetY)),targetX=void 0,targetY=void 0)}CANVAS._objects.sort((e,t)=>Math.sign(e.z-t.z)),CANVAS.renderAll()};update();export default DRAWING;